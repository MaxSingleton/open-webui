version: "3.9"
services:
  open-webui:
    container_name: open-webui-dev
    # build only the backend (base) stage from the multi-stage Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    working_dir: /app/backend
    volumes:
      - ./backend:/app/backend:delegated
      - open-webui:/app/backend/data
    ports:
      - "8080:8080"
    environment:
      - ENV=dev
      - WEBUI_SECRET_KEY=dev-secret-key
      - ENABLE_OLLAMA_API=false
      - USE_OLLAMA_DOCKER=false
      - OPENWEBUI_IMAGE_PROXY=off
    # Install deps and start backend with hot reload
    command: >
      sh -c "pip install --no-cache-dir -r requirements.txt && uvicorn open_webui.main:app --host 0.0.0.0 --port 8080 --reload"

  frontend:
    container_name: open-webui-frontend-dev
    image: node:22-alpine3.20
    working_dir: /app
    volumes:
      - ./:/app:delegated
      - frontend_node_modules:/app/node_modules:delegated
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - APP_BUILD_HASH=dev-build
    depends_on:
      - open-webui
    command: >
      sh -c 'npm ci --no-audit --prefer-offline && npm run dev:fast'

volumes:
  frontend_node_modules: